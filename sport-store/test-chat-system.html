<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat System Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.connecting { background: #fff3cd; color: #856404; }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        .message-input {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .message-input input {
            flex: 1;
        }
        .messages {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            background: white;
            border-left: 3px solid #007bff;
        }
        .message.user { border-left-color: #28a745; }
        .message.admin { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <h1>üß™ Chat System Test Dashboard</h1>
    <p>Test h·ªá th·ªëng chat real-time v·ªõi Socket.IO</p>

    <div class="test-container">
        <!-- User Test Section -->
        <div class="test-section">
            <h2>üë§ User Test</h2>
            <div>
                <label>User ID:</label>
                <input type="text" id="userId" value="test_user_123" placeholder="Enter user ID">
            </div>
            <div>
                <label>User Name:</label>
                <input type="text" id="userName" value="Test User" placeholder="Enter user name">
            </div>
            <div>
                <button onclick="connectUser()">Connect as User</button>
                <button onclick="disconnectUser()">Disconnect</button>
            </div>
            <div id="userStatus" class="status disconnected">Disconnected</div>
            
            <h3>Messages</h3>
            <div class="message-input">
                <input type="text" id="userMessage" placeholder="Type message...">
                <button onclick="sendUserMessage()">Send</button>
            </div>
            <div id="userMessages" class="messages"></div>
            
            <h3>Logs</h3>
            <div id="userLog" class="log"></div>
        </div>

        <!-- Admin Test Section -->
        <div class="test-section">
            <h2>üë®‚Äçüíº Admin Test</h2>
            <div>
                <label>Admin Name:</label>
                <input type="text" id="adminName" value="Test Admin" placeholder="Enter admin name">
            </div>
            <div>
                <button onclick="connectAdmin()">Connect as Admin</button>
                <button onclick="disconnectAdmin()">Disconnect</button>
            </div>
            <div id="adminStatus" class="status disconnected">Disconnected</div>
            
            <h3>Send to User</h3>
            <div>
                <label>Recipient ID:</label>
                <input type="text" id="recipientId" value="test_user_123" placeholder="Enter recipient ID">
            </div>
            <div class="message-input">
                <input type="text" id="adminMessage" placeholder="Type message...">
                <button onclick="sendAdminMessage()">Send</button>
            </div>
            <div id="adminMessages" class="messages"></div>
            
            <h3>Logs</h3>
            <div id="adminLog" class="log"></div>
        </div>
    </div>

    <!-- System Test Section -->
    <div class="test-section" style="margin-top: 20px;">
        <h2>üîß System Test</h2>
        <button onclick="testAPI()">Test API Endpoints</button>
        <button onclick="clearAllLogs()">Clear All Logs</button>
        <button onclick="testConnection()">Test Connection</button>
        <div id="systemLog" class="log"></div>
    </div>

    <script>
        let userSocket = null;
        let adminSocket = null;
        let userConnected = false;
        let adminConnected = false;

        // Socket URL
        const SOCKET_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:4000' 
            : window.location.origin.replace('http', 'ws');

        function log(message, type = 'info', target = 'systemLog') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById(target);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(elementId, connected, text) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function addMessage(containerId, message, sender) {
            const container = document.getElementById(containerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `
                <strong>${sender === 'user' ? 'üë§' : 'üë®‚Äçüíº'} ${message.senderName || sender}:</strong><br>
                ${message.text}<br>
                <small>${new Date(message.timestamp || Date.now()).toLocaleTimeString()}</small>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // User Functions
        function connectUser() {
            if (userSocket) {
                userSocket.disconnect();
            }

            const userId = document.getElementById('userId').value;
            const userName = document.getElementById('userName').value;

            log(`üîå Connecting user: ${userId} (${userName})`, 'info', 'userLog');
            updateStatus('userStatus', false, 'Connecting...');

            userSocket = io(SOCKET_URL, {
                transports: ['websocket', 'polling'],
                timeout: 10000
            });

            userSocket.on('connect', () => {
                userConnected = true;
                updateStatus('userStatus', true, 'Connected');
                log(`‚úÖ User connected: ${userSocket.id}`, 'success', 'userLog');
                
                // Identify user
                userSocket.emit('identifyUser', { userId, userName, isAdmin: false });
                log(`üì§ Sent identifyUser event`, 'info', 'userLog');
            });

            userSocket.on('identified', (data) => {
                log(`‚úÖ User identified: ${JSON.stringify(data)}`, 'success', 'userLog');
            });

            userSocket.on('receiveMessage', (message) => {
                log(`üì• Received message: ${JSON.stringify(message)}`, 'info', 'userLog');
                addMessage('userMessages', message, 'admin');
            });

            userSocket.on('disconnect', () => {
                userConnected = false;
                updateStatus('userStatus', false, 'Disconnected');
                log(`‚ùå User disconnected`, 'error', 'userLog');
            });

            userSocket.on('connect_error', (error) => {
                log(`‚ùå User connection error: ${error.message}`, 'error', 'userLog');
                updateStatus('userStatus', false, 'Connection Error');
            });
        }

        function disconnectUser() {
            if (userSocket) {
                userSocket.disconnect();
                userSocket = null;
                userConnected = false;
                updateStatus('userStatus', false, 'Disconnected');
                log(`üîå User disconnected manually`, 'info', 'userLog');
            }
        }

        function sendUserMessage() {
            if (!userSocket || !userConnected) {
                log(`‚ùå User not connected`, 'error', 'userLog');
                return;
            }

            const message = document.getElementById('userMessage').value;
            if (!message.trim()) return;

            const userId = document.getElementById('userId').value;
            const userName = document.getElementById('userName').value;

            userSocket.emit('sendMessage', { 
                text: message,
                userId,
                userName
            });

            const messageData = {
                senderName: userName,
                text: message,
                timestamp: new Date().toISOString()
            };

            addMessage('userMessages', messageData, 'user');
            log(`üì§ Sent message: ${message}`, 'info', 'userLog');
            document.getElementById('userMessage').value = '';
        }

        // Admin Functions
        function connectAdmin() {
            if (adminSocket) {
                adminSocket.disconnect();
            }

            const adminName = document.getElementById('adminName').value;

            log(`üîå Connecting admin: ${adminName}`, 'info', 'adminLog');
            updateStatus('adminStatus', false, 'Connecting...');

            adminSocket = io(SOCKET_URL, {
                transports: ['websocket', 'polling'],
                timeout: 10000
            });

            adminSocket.on('connect', () => {
                adminConnected = true;
                updateStatus('adminStatus', true, 'Connected');
                log(`‚úÖ Admin connected: ${adminSocket.id}`, 'success', 'adminLog');
                
                // Identify admin
                adminSocket.emit('identifyUser', { isAdmin: true, userName: adminName });
                log(`üì§ Sent identifyUser event for admin`, 'info', 'adminLog');
            });

            adminSocket.on('identified', (data) => {
                log(`‚úÖ Admin identified: ${JSON.stringify(data)}`, 'success', 'adminLog');
            });

            adminSocket.on('receiveMessage', (message) => {
                log(`üì• Received message: ${JSON.stringify(message)}`, 'info', 'adminLog');
                addMessage('adminMessages', message, 'user');
            });

            adminSocket.on('disconnect', () => {
                adminConnected = false;
                updateStatus('adminStatus', false, 'Disconnected');
                log(`‚ùå Admin disconnected`, 'error', 'adminLog');
            });

            adminSocket.on('connect_error', (error) => {
                log(`‚ùå Admin connection error: ${error.message}`, 'error', 'adminLog');
                updateStatus('adminStatus', false, 'Connection Error');
            });
        }

        function disconnectAdmin() {
            if (adminSocket) {
                adminSocket.disconnect();
                adminSocket = null;
                adminConnected = false;
                updateStatus('adminStatus', false, 'Disconnected');
                log(`üîå Admin disconnected manually`, 'info', 'adminLog');
            }
        }

        function sendAdminMessage() {
            if (!adminSocket || !adminConnected) {
                log(`‚ùå Admin not connected`, 'error', 'adminLog');
                return;
            }

            const message = document.getElementById('adminMessage').value;
            if (!message.trim()) return;

            const recipientId = document.getElementById('recipientId').value;
            const adminName = document.getElementById('adminName').value;

            adminSocket.emit('sendMessage', { 
                text: message,
                recipientId,
                senderId: 'admin',
                senderName: adminName
            });

            const messageData = {
                senderName: adminName,
                text: message,
                timestamp: new Date().toISOString()
            };

            addMessage('adminMessages', messageData, 'admin');
            log(`üì§ Sent message to ${recipientId}: ${message}`, 'info', 'adminLog');
            document.getElementById('adminMessage').value = '';
        }

        // System Functions
        function testAPI() {
            log(`üåê Testing API endpoints...`, 'info');
            
            // Test conversations API
            fetch('/api/chat/conversations', {
                headers: {
                    'Authorization': 'Bearer test_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                log(`‚úÖ Conversations API: ${JSON.stringify(data)}`, 'success');
            })
            .catch(error => {
                log(`‚ùå Conversations API error: ${error.message}`, 'error');
            });
        }

        function testConnection() {
            log(`üîå Testing socket connection to: ${SOCKET_URL}`, 'info');
            
            const testSocket = io(SOCKET_URL, {
                transports: ['websocket', 'polling'],
                timeout: 5000
            });

            testSocket.on('connect', () => {
                log(`‚úÖ Socket connection successful: ${testSocket.id}`, 'success');
                testSocket.disconnect();
            });

            testSocket.on('connect_error', (error) => {
                log(`‚ùå Socket connection failed: ${error.message}`, 'error');
            });
        }

        function clearAllLogs() {
            document.getElementById('userLog').textContent = '';
            document.getElementById('adminLog').textContent = '';
            document.getElementById('systemLog').textContent = '';
            document.getElementById('userMessages').innerHTML = '';
            document.getElementById('adminMessages').innerHTML = '';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'userMessage') {
                    sendUserMessage();
                } else if (document.activeElement.id === 'adminMessage') {
                    sendAdminMessage();
                }
            }
        });

        // Auto-connect on load
        window.onload = function() {
            log(`üöÄ Chat System Test Dashboard Loaded`, 'info');
            log(`üîå Socket URL: ${SOCKET_URL}`, 'info');
            log(`üì± Ready to test chat functionality`, 'info');
        };
    </script>
</body>
</html> 